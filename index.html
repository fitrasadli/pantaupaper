<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Paper Akademik</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        .container {
            max-width: 1280px;
        }
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

    <!-- BAGIAN 1: LOGIN SECTION -->
    <div id="loginSection" class="flex-grow flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md border-t-4 border-yellow-500">
            <div class="text-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Login Area</h1>
                <p class="text-gray-500 text-sm mt-2">Silakan masuk untuk mengelola paper.</p>
            </div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="username">Username</label>
                    <input type="text" id="username" placeholder="Masukkan username" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
                </div>
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="password">Password</label>
                    <input type="password" id="password" placeholder="Masukkan password" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
                </div>
                
                <button type="submit" 
                    class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-lg transition duration-300 shadow-md disabled:opacity-50">
                    Masuk
                </button>
            </form>
            <p id="loginError" class="text-red-500 text-center mt-4 text-sm hidden"></p>
        </div>
    </div>

    <!-- BAGIAN 2: APLIKASI UTAMA (Disembunyikan Default) -->
    <div id="appSection" class="hidden p-4 md:p-8">
        <div class="container mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 border-b-4 border-yellow-600 pb-2">
                <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800">
                    Sistem Manajemen Paper
                </h1>
                <button id="logoutButton" class="mt-4 md:mt-0 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition shadow">
                    Logout
                </button>
            </div>

            <!-- Form Tambah Paper -->
            <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg mb-8">
                <h2 class="text-2xl font-semibold text-yellow-700 mb-4">Tambah Paper Baru</h2>
                <form id="paperForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="text" id="title" placeholder="Judul Paper (Wajib)" required
                           class="col-span-1 md:col-span-2 p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                    <input type="text" id="authors" placeholder="Nama Penulis (Pisahkan dengan koma)"
                           class="p-3 border border-gray-300 rounded-lg">
                    <select id="status" required
                            class="p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                        <option value="" disabled selected>Pilih Status</option>
                        <option value="Draft">Draft</option>
                        <option value="Submitted">Submitted</option>
                        <option value="Under Review">Under Review</option>
                        <option value="Accepted">Accepted</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                    <input type="text" id="category" placeholder="Kategori (Jurnal/Konferensi/Lainnya)"
                           class="p-3 border border-gray-300 rounded-lg">
                    <input type="date" id="deadline" placeholder="Deadline"
                           class="p-3 border border-gray-300 rounded-lg">
                    <input type="url" id="reference_link" placeholder="Link Referensi (URL)"
                           class="p-3 border border-gray-300 rounded-lg">
                    <input type="url" id="overleaf_link" placeholder="Link Overleaf (URL)"
                           class="p-3 border border-gray-300 rounded-lg">
                    <input type="url" id="ppt_link" placeholder="Link PPT/Slide (URL)"
                           class="p-3 border border-gray-300 rounded-lg">
                    
                    <button type="submit" id="submitButton"
                            class="col-span-1 md:col-span-3 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-lg transition duration-300 shadow-md hover:shadow-lg disabled:opacity-50">
                        Tambah Paper
                    </button>
                    <p id="formMessage" class="col-span-3 text-sm text-center hidden"></p>
                </form>
            </div>

            <!-- Bagian Pencarian dan Daftar Paper -->
            <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-yellow-700 mb-4">Daftar Paper</h2>
                
                <!-- Input Pencarian -->
                <input type="text" id="search" placeholder="Cari berdasarkan Judul atau Penulis..."
                       class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">

                <!-- Tabel Paper -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Judul</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Penulis</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Kategori</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Deadline</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tautan</th>
                            </tr>
                        </thead>
                        <tbody id="papersList" class="bg-white divide-y divide-gray-200">
                            <!-- Data paper akan dimasukkan di sini oleh JavaScript -->
                            <tr id="loadingRow">
                                <td colspan="6" class="p-4 text-center text-gray-500">Memuat data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                 <p id="noDataMessage" class="hidden p-4 text-center text-gray-500 mt-4">Tidak ada paper yang ditemukan.</p>
            </div>
        </div>
    </div>

    <!-- Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        // --- KONFIGURASI SUPABASE ---
        const SUPABASE_URL = 'https://lkldrnughtjtwlbnzrup.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_P3m8csALCDa3-tJvoLhIBQ_AD_UkmDV';
        const TABLE_NAME = 'papers';

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- REFERENSI DOM ---
        // Login Elements
        const loginSection = document.getElementById('loginSection');
        const appSection = document.getElementById('appSection');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const logoutButton = document.getElementById('logoutButton');

        // App Elements
        const papersList = document.getElementById('papersList');
        const paperForm = document.getElementById('paperForm');
        const searchInput = document.getElementById('search');
        const loadingRow = document.getElementById('loadingRow');
        const noDataMessage = document.getElementById('noDataMessage');
        const formMessage = document.getElementById('formMessage');
        const submitButton = document.getElementById('submitButton');

        // --- LOGIKA LOGIN ---

        // Cek sesi saat halaman dimuat
        function checkSession() {
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');
            if (isLoggedIn === 'true') {
                showApp();
            } else {
                showLogin();
            }
        }

        function showLogin() {
            loginSection.classList.remove('hidden');
            appSection.classList.add('hidden');
            document.body.classList.remove('bg-gray-50'); // Optional styling reset
        }

        function showApp() {
            loginSection.classList.add('hidden');
            appSection.classList.remove('hidden');
            // Muat data paper HANYA jika sudah login
            fetchPapers();
        }

        // Event Listener Login yang Diperbarui (Menggunakan Database)
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const submitBtn = loginForm.querySelector('button[type="submit"]');

            // Feedback visual loading
            const originalText = submitBtn.innerText;
            submitBtn.disabled = true;
            submitBtn.innerText = "Memeriksa...";
            loginError.classList.add('hidden');

            try {
                // Query ke tabel 'users' di Supabase
                // PENTING: Tabel 'users' harus sudah dibuat di Supabase
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('username', user)
                    .eq('password', pass)
                    .maybeSingle(); // Mengambil satu baris atau null

                if (error) {
                    throw error;
                }

                if (data) {
                    // Login Sukses
                    sessionStorage.setItem('isLoggedIn', 'true');
                    showApp();
                } else {
                    // Login Gagal (User tidak ditemukan atau password salah)
                    throw new Error("Username atau Password salah!");
                }
            } catch (err) {
                console.error("Login error:", err);
                // Menangani pesan error
                let errorMessage = "Terjadi kesalahan saat login.";
                if (err.message) {
                   if (err.message.includes('relation "users" does not exist')) {
                        errorMessage = "Error: Tabel 'users' belum dibuat di database.";
                   } else {
                        errorMessage = err.message;
                   }
                }
                loginError.textContent = errorMessage;
                loginError.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerText = originalText;
            }
        });

        logoutButton.addEventListener('click', () => {
            sessionStorage.removeItem('isLoggedIn');
            window.location.reload(); // Reload halaman untuk reset state
        });

        // --- LOGIKA APLIKASI (PAPER) ---

        function getStatusBadge(status) {
            let color = '';
            switch (status) {
                case 'Draft': color = 'bg-yellow-100 text-yellow-800'; break;
                case 'Submitted': color = 'bg-blue-100 text-blue-800'; break;
                case 'Under Review': color = 'bg-purple-100 text-purple-800'; break;
                case 'Accepted': color = 'bg-green-100 text-green-800'; break;
                case 'Rejected': color = 'bg-red-100 text-red-800'; break;
                default: color = 'bg-gray-100 text-gray-800';
            }
            return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${color}">${status}</span>`;
        }

        function createPaperRow(paper) {
            const deadlineDate = paper.deadline ? new Date(paper.deadline).toLocaleDateString('id-ID') : '-';

            const linkIcon = (url, iconName, label) => {
                if (!url) return '';
                return `
                    <a href="${url}" target="_blank" rel="noopener noreferrer" 
                       class="text-gray-500 hover:text-yellow-600 transition duration-150 mx-0.5" 
                       title="${label}">
                        <i data-lucide="${iconName}" class="w-5 h-5"></i>
                    </a>
                `;
            };

            const links = `
                ${linkIcon(paper.reference_link, 'link', 'Link Referensi')}
                ${linkIcon(paper.overleaf_link, 'file-text', 'Link Overleaf')}
                ${linkIcon(paper.ppt_link, 'monitor', 'Link PPT')}
            `;
            
            return `
                <tr class="hover:bg-yellow-50 transition duration-150">
                    <td class="px-3 py-4 whitespace-normal text-sm font-medium text-gray-900">${paper.title}</td>
                    <td class="px-3 py-4 whitespace-normal text-sm text-gray-500">${paper.authors || '-'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm">${getStatusBadge(paper.status)}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell">${paper.category || '-'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell">${deadlineDate}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-700 flex space-x-1 items-center">
                        ${links}
                    </td>
                </tr>
            `;
        }
        
        async function fetchPapers(searchTerm = '') {
            loadingRow.classList.remove('hidden');
            papersList.innerHTML = '';
            noDataMessage.classList.add('hidden');

            try {
                let query = supabaseClient.from(TABLE_NAME)
                    .select('*')
                    .order('created_at', { ascending: false });

                if (searchTerm) {
                    const searchPattern = `%${searchTerm.toLowerCase()}%`;
                    query = query.or(`title.ilike.${searchPattern},authors.ilike.${searchPattern}`);
                }

                const { data, error } = await query;

                if (error) throw error;

                papersList.innerHTML = '';
                if (data && data.length > 0) {
                    data.forEach(paper => {
                        papersList.insertAdjacentHTML('beforeend', createPaperRow(paper));
                    });
                    lucide.createIcons();
                } else {
                    noDataMessage.classList.remove('hidden');
                }

            } catch (error) {
                console.error('Error fetching papers:', error.message);
                papersList.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">Gagal memuat data: ${error.message}</td></tr>`;
            } finally {
                loadingRow.classList.add('hidden');
            }
        }

        async function addPaper(event) {
            event.preventDefault();

            const newPaper = {
                title: document.getElementById('title').value.trim(),
                authors: document.getElementById('authors').value.trim(),
                status: document.getElementById('status').value,
                category: document.getElementById('category').value.trim() || null,
                deadline: document.getElementById('deadline').value || null,
                reference_link: document.getElementById('reference_link').value.trim() || null,
                overleaf_link: document.getElementById('overleaf_link').value.trim() || null,
                ppt_link: document.getElementById('ppt_link').value.trim() || null,
            };

            if (!newPaper.title || !newPaper.status) {
                showMessage('Judul dan Status wajib diisi!', 'text-red-500');
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Menyimpan...';

            try {
                const { error } = await supabaseClient.from(TABLE_NAME).insert([newPaper]);

                if (error) throw error;

                paperForm.reset();
                showMessage('Paper berhasil ditambahkan!', 'text-green-500');
                fetchPapers(searchInput.value);

            } catch (error) {
                console.error('Error adding paper:', error.message);
                showMessage(`Gagal menambahkan paper: ${error.message}`, 'text-red-500');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Tambah Paper';
            }
        }

        function showMessage(message, colorClass) {
            formMessage.textContent = message;
            formMessage.className = `col-span-3 text-sm text-center ${colorClass}`;
            formMessage.classList.remove('hidden');
            setTimeout(() => {
                formMessage.classList.add('hidden');
            }, 3000);
        }

        // --- EVENT LISTENERS ---

        paperForm.addEventListener('submit', addPaper);

        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                fetchPapers(searchInput.value);
            }, 300);
        });

        // --- INISIALISASI ---

        document.addEventListener('DOMContentLoaded', () => {
            // Ganti pemanggilan langsung fetchPapers dengan pengecekan sesi login
            checkSession();
        });

    </script>
</body>
</html>

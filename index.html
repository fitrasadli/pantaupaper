<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Paper & Materi Akademik</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom Styles dari kode yang Anda berikan */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        
        .container {
            max-width: 1400px;
        }

        /* --- Gaya Navigasi (Diambil dari input user) --- */
        .nav-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 1rem;
            background-color: #F0E68C; /* Khaki (Kuning Muda) */
            border-radius: 0.5rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: background-color 0.3s, box-shadow 0.3s;
            /* Tambahan untuk menyesuaikan lebar di dalam aside p-6 */
            margin-left: -1rem;
            margin-right: -1rem;
            width: calc(100% + 2rem);
        }

        .nav-item-inactive:hover {
            background-color: #FFEB3B; /* Kuning lebih cerah saat hover */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .nav-text {
            font-weight: bold;
            color: #4B5563; /* Teks abu-abu */
            font-size: 1rem;
            margin-left: 0.75rem; /* Jarak antara ikon dan teks */
        }

        .nav-item-inactive:hover .nav-text {
            color: #2C3E50; /* Teks lebih gelap saat hover */
        }

        .nav-item-active {
            background-color: #FFD700; /* Gold (Kuning Emas) */
            color: white;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            font-weight: bold;
        }

        .nav-item-active .nav-text {
            font-weight: bold;
            color: white; /* Teks putih di item aktif */
        }
        /* Mengatur warna ikon di item aktif */
        .nav-item-active i {
            color: white; 
        }
        /* Mengatur warna ikon di item non-aktif */
        .nav-item-inactive i {
            color: #D6A238; /* Kuning Emas agak gelap untuk ikon non-aktif */
            transition: color 0.3s;
        }
        .nav-item-inactive:hover i {
            color: #B8860B; /* Warna ikon lebih kuat saat hover */
        }

        /* Additional styling */
        #mainNav {
            margin-top: 20px;
            /* Mengganti space-y-2 menjadi gap-2 pada nav element */
        }
        
        /* --- Gaya Asli Aplikasi yang Dipertahankan/Disesuaikan --- */
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        /* Style for the visual side - SANGAT LEMBUT/PUTIH */
        #visual-side {
            background: linear-gradient(135deg, #fffcf5, #ffffff);
            color: #4b5563;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-fast {
            animation: spin 0.5s linear infinite;
        }
        .sortable-header {
            transition: background-color 0.2s ease-in-out;
        }
        .sort-icon-wrapper i {
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        .main-page-header {
            /* Kontainer utama untuk judul */
            @apply bg-white p-5 rounded-xl shadow-lg border-l-8 border-yellow-500 mb-4;
        }
        .view-background-texture {
            background-color: #fefefe;
            background-image: repeating-linear-gradient(
                45deg, 
                #fcfcfc, 
                #fcfcfc 15px, 
                #f9f9f9 15px, 
                #f9f9f9 30px
            );
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.03);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- BAGIAN 1: LOGIN SECTION -->
    <div id="loginSection" class="flex-grow flex items-center justify-center p-4">
        <div class="w-full max-w-sm md:max-w-4xl lg:max-w-5xl flex rounded-2xl shadow-2xl overflow-hidden">
            
            <!-- Left Side: Visual/Logo -->
            <div id="visual-side" class="hidden md:block md:w-1/2 p-12 relative flex flex-col justify-center items-center">
                <div class="text-center">
                    <!-- LOGO DI SINI -->
                    <img id="loginLogo" 
                        class="max-w-[150px] h-auto mx-auto mb-4 p-3 rounded-xl shadow-lg object-contain border border-yellow-100" 
                        src="" 
                        alt="Logo Hexacomm.png"
                        onerror="this.onerror=null; this.src='https://placehold.co/150x150/fde047/78350f?text=Hexa';">
                    <!-- AKHIR LOGO -->

                    <h2 class="text-3xl font-extrabold mb-2 text-yellow-700">Paper Riset Hexacomm</h2>
                    <p class="mt-4 leading-relaxed text-gray-600">
                        Website pemantau paper kalian.
                    </p>
                    <div class="mt-8">
                        <span class="text-sm font-semibold border-b-2 border-yellow-700 text-yellow-800">#HexaRnd</span>
                    </div>
                </div>
            </div>

            <!-- Right Side: Login Form -->
            <div class="w-full md:w-1/2 bg-white p-8 md:p-10 lg:p-12">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800">Masukkan ID Anda</h1>
                    <p class="text-gray-500 text-sm mt-2">Belum ada? tanya RnD</p>
                </div>

                <form id="loginForm" class="space-y-6">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="username">Username</label>
                        <input type="text" id="username" placeholder="Masukkan username" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="password">Password</label>
                        <input type="password" id="password" placeholder="Masukkan password" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
                    </div>
                    
                    <button type="submit" 
                        class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-lg transition duration-300 shadow-lg disabled:opacity-50">
                        Masuk
                    </button>
                </form>
                <p id="loginError" class="text-red-500 text-center mt-6 text-sm hidden"></p>
            </div>
        </div>
    </div>

    <!-- BAGIAN 2: APLIKASI UTAMA (Diperbarui dengan Sidebar) -->
    <div id="appSection" class="hidden flex-grow flex p-4 md:p-8">
        <div class="container mx-auto flex flex-col lg:flex-row space-y-6 lg:space-y-0 lg:space-x-8">

            <!-- SIDEBAR NAVIGASI -->
            <aside class="w-full lg:w-64 bg-white p-6 rounded-xl shadow-lg flex-shrink-0">
                <div class="flex flex-col mb-8 border-b pb-4">
                    <div class="flex items-center text-xl font-bold text-gray-800 mb-4">
                        <img id="headerLogo" 
                            class="w-8 h-8 mr-2 object-contain rounded-md" 
                            src="" 
                            alt="Logo"
                            onerror="this.onerror=null; this.src='https://placehold.co/32x32/fde047/78350f?text=H';">
                        <span class="text-yellow-600">Hexa RnD</span>
                    </div>
                    <button id="logoutButton" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-semibold transition shadow flex items-center justify-center space-x-1">
                        <i data-lucide="log-out" class="w-4 h-4"></i>
                        <span>Logout</span>
                    </button>
                </div>

                <nav id="mainNav" class="space-y-2">
                    <!-- Menu Buttons (Menggunakan struktur baru yang Anda berikan) -->
                    <div id="nav-paper" class="nav-item nav-item-active" data-view="paper">
                        <i data-lucide="file-text" class="w-5 h-5 mr-3"></i>
                        <span class="nav-text">Manajemen Paper</span>
                    </div>
                    <div id="nav-materi" class="nav-item nav-item-inactive" data-view="materi">
                        <i data-lucide="folder-tree" class="w-5 h-5 mr-3"></i>
                        <span class="nav-text">Manajemen Materi</span>
                    </div>
                </nav>
            </aside>
            
            <!-- KONTEN UTAMA -->
            <main id="mainContent" class="flex-grow w-full">
                <!-- VIEW 1: MANAJEMEN PAPER -->
                <div id="paperView" class="view-content hidden space-y-4">
                    
                    <!-- HEADER SECTION BARU -->
                    <div class="main-page-header">
                        <h1 class="text-3xl font-bold text-gray-800 flex items-center p-0">
                            <i data-lucide="file-text" class="w-8 h-8 mr-3 text-yellow-600"></i>
                            Manajemen Paper
                        </h1>
                        <p class="text-sm text-gray-500 mt-1 pl-11">Kelola, tambah, dan pantau status paper riset.</p>
                    </div>

                    <div class="view-background-texture space-y-8 p-6">
                    
                        <!-- Form Tambah Paper -->
                        <div class="bg-white p-6 md:p-8 rounded-xl shadow-xl border-t-4 border-yellow-500">
                            <h2 class="text-2xl font-semibold text-yellow-700 mb-4 flex items-center space-x-2">
                                <i data-lucide="book-plus" class="w-6 h-6"></i>
                                <span>Tambah Paper Baru</span>
                            </h2>
                            <form id="paperForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <input type="text" id="title" placeholder="Judul Paper (Wajib)" required
                                    class="col-span-1 md:col-span-2 p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                                <input type="text" id="authors" placeholder="Nama Penulis (Pisahkan dengan koma)"
                                    class="p-3 border border-gray-300 rounded-lg">
                                <select id="status" required
                                    class="p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                                    <option value="" disabled selected>Pilih Status</option>
                                    <option value="Draft">Draft</option>
                                    <option value="Submitted">Submitted</option>
                                    <option value="Under Review">Under Review</option>
                                    <option value="Accepted">Accepted</option>
                                    <option value="Rejected">Rejected</option>
                                </select>
                                <input type="text" id="category" placeholder="Kategori (Jurnal/Konferensi/Lainnya)"
                                    class="p-3 border border-gray-300 rounded-lg">
                                <input type="date" id="deadline" placeholder="Deadline"
                                    class="p-3 border border-gray-300 rounded-lg">
                                <input type="url" id="reference_link" placeholder="Link Referensi (URL)"
                                    class="p-3 border border-gray-300 rounded-lg">
                                <input type="url" id="overleaf_link" placeholder="Link Overleaf (URL)"
                                    class="p-3 border border-gray-300 rounded-lg">
                                <input type="url" id="ppt_link" placeholder="Link PPT/Slide (URL)"
                                    class="p-3 border border-gray-300 rounded-lg">
                                
                                <button type="submit" id="submitPaperButton"
                                    class="col-span-1 md:col-span-3 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-xl transition duration-300 shadow-xl shadow-yellow-400/50 hover:shadow-2xl hover:shadow-yellow-500/70 disabled:opacity-50 flex items-center justify-center space-x-2">
                                    <!-- Konten diisi oleh JS -->
                                </button>
                                <p id="formPaperMessage" class="col-span-3 text-sm text-center hidden"></p>
                            </form>
                        </div>

                        <!-- Bagian Pencarian dan Daftar Paper -->
                        <div class="bg-white p-6 md:p-8 rounded-xl shadow-xl">
                            <h2 class="text-2xl font-semibold text-yellow-700 mb-4 flex items-center space-x-2">
                                <i data-lucide="list-checks" class="w-6 h-6"></i>
                                <span>Daftar Paper</span>
                            </h2>
                            
                            <!-- Input Pencarian -->
                            <input type="text" id="searchPaper" placeholder="Cari berdasarkan Judul atau Penulis..."
                                class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">

                            <!-- Tabel Paper -->
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th onclick="handleHeaderSortClick('title', 'paper')" data-sort-key="title" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 sortable-header">
                                                <div class="flex items-center space-x-1"><span>Judul</span> <span class="sort-icon-wrapper paper" data-col="title"></span></div>
                                            </th>
                                            <th onclick="handleHeaderSortClick('authors', 'paper')" data-sort-key="authors" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 sortable-header">
                                                <div class="flex items-center space-x-1"><span>Penulis</span> <span class="sort-icon-wrapper paper" data-col="authors"></span></div>
                                            </th>
                                            <th onclick="handleHeaderSortClick('status', 'paper')" data-sort-key="status" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 sortable-header">
                                                <div class="flex items-center space-x-1"><span>Status</span> <span class="sort-icon-wrapper paper" data-col="status"></span></div>
                                            </th>
                                            <th onclick="handleHeaderSortClick('category', 'paper')" data-sort-key="category" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell cursor-pointer hover:bg-gray-100 sortable-header">
                                                <div class="flex items-center space-x-1"><span>Kategori</span> <span class="sort-icon-wrapper paper" data-col="category"></span></div>
                                            </th>
                                            <th onclick="handleHeaderSortClick('deadline', 'paper')" data-sort-key="deadline" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell cursor-pointer hover:bg-gray-100 sortable-header">
                                                <div class="flex items-center space-x-1"><span>Deadline</span> <span class="sort-icon-wrapper paper" data-col="deadline"></span></div>
                                            </th>
                                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="papersList" class="bg-white divide-y divide-gray-200">
                                        <!-- Data paper akan dimasukkan di sini oleh JavaScript -->
                                    </tbody>
                                </table>
                                <p id="noPaperDataMessage" class="hidden p-4 text-center text-gray-500 mt-4">Tidak ada paper yang ditemukan.</p>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- VIEW 2: MANAJEMEN MATERI (BARU) -->
                <div id="materiView" class="view-content hidden space-y-4">
                    
                    <!-- HEADER SECTION BARU -->
                    <div class="main-page-header">
                        <h1 class="text-3xl font-bold text-gray-800 flex items-center p-0">
                            <i data-lucide="folder-tree" class="w-8 h-8 mr-3 text-yellow-600"></i>
                            Manajemen Materi
                        </h1>
                        <p class="text-sm text-gray-500 mt-1 pl-11">Arsip dan kelola materi presentasi atau *sharing knowledge*.</p>
                    </div>

                    <div class="view-background-texture space-y-8 p-6">
                        
                        <!-- Form Tambah Materi -->
                        <div class="bg-white p-6 md:p-8 rounded-xl shadow-xl border-t-4 border-yellow-500">
                            <h2 class="text-2xl font-semibold text-yellow-700 mb-4 flex items-center space-x-2">
                                <i data-lucide="folder-plus" class="w-6 h-6"></i>
                                <span>Tambah Materi Baru</span>
                            </h2>
                            <form id="materiForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <select id="divisi" required
                                    class="p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                                    <option value="" disabled selected>Pilih Divisi (Wajib)</option>
                                    <option value="5G">5G</option>
                                    <option value="IoT">IoT</option>
                                    <option value="Umum">Umum</option>
                                </select>
                                <input type="text" id="judul_materi" placeholder="Judul Materi (Wajib)" required
                                    class="col-span-1 md:col-span-2 p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                                <input type="text" id="pembuat" placeholder="Nama Pembuat"
                                    class="p-3 border border-gray-300 rounded-lg">
                                <input type="date" id="tanggal_jadi" placeholder="Tanggal Jadi"
                                    class="p-3 border border-gray-300 rounded-lg">
                                <input type="url" id="link_materi" placeholder="Link Materi (URL Wajib)" required
                                    class="col-span-1 md:col-span-2 p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                                
                                <button type="submit" id="submitMateriButton"
                                    class="col-span-1 md:col-span-3 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-xl transition duration-300 shadow-xl shadow-yellow-400/50 hover:shadow-2xl hover:shadow-yellow-500/70 disabled:opacity-50 flex items-center justify-center space-x-2">
                                    <!-- Konten diisi oleh JS -->
                                </button>
                                <p id="formMateriMessage" class="col-span-3 text-sm text-center hidden"></p>
                            </form>
                        </div>

                        <!-- Bagian Pencarian dan Daftar Materi -->
                        <div class="bg-white p-6 md:p-8 rounded-xl shadow-xl">
                            <h2 class="text-2xl font-semibold text-yellow-700 mb-4 flex items-center space-x-2">
                                <i data-lucide="list" class="w-6 h-6"></i>
                                <span>Daftar Materi</span>
                            </h2
                             <!-- Input Pencarian Materi -->
                            <input type="text" id="searchMateri" placeholder="Cari berdasarkan Judul atau Pembuat..."
                                class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">

                            <!-- Tabel Materi -->
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th onclick="handleHeaderSortClick('judul_materi', 'materi')" data-sort-key="judul_materi" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 sortable-header">
                                                <div class="flex items-center space-x-1"><span>Judul Materi</span> <span class="sort-icon-wrapper materi" data-col="judul_materi"></span></div>
                                            </th>
                                            <th onclick="handleHeaderSortClick('divisi', 'materi')" data-sort-key="divisi" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 sortable-header">
                                                <div class="flex items-center space-x-1"><span>Divisi</span> <span class="sort-icon-wrapper materi" data-col="divisi"></span></div>
                                            </th>
                                            <th onclick="handleHeaderSortClick('pembuat', 'materi')" data-sort-key="pembuat" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell cursor-pointer hover:bg-gray-100 sortable-header">
                                                <div class="flex items-center space-x-1"><span>Pembuat</span> <span class="sort-icon-wrapper materi" data-col="pembuat"></span></div>
                                            </th>
                                            <th onclick="handleHeaderSortClick('tanggal_jadi', 'materi')" data-sort-key="tanggal_jadi" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell cursor-pointer hover:bg-gray-100 sortable-header">
                                                <div class="flex items-center space-x-1"><span>Tgl Jadi</span> <span class="sort-icon-wrapper materi" data-col="tanggal_jadi"></span></div>
                                            </th>
                                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="materiList" class="bg-white divide-y divide-gray-200">
                                        <!-- Data materi akan dimasukkan di sini oleh JavaScript -->
                                    </tbody>
                                </table>
                                <p id="noMateriDataMessage" class="hidden p-4 text-center text-gray-500 mt-4">Tidak ada materi yang ditemukan.</p>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- BAGIAN 3: MODAL EDIT PAPER (Tidak Berubah) -->
    <div id="editModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-yellow-700 mb-4 flex items-center space-x-2 border-b pb-2">
                <i data-lucide="file-edit" class="w-6 h-6"></i>
                <span>Edit Detail Paper</span>
            </h3>
            <button onclick="closeEditModal('paper')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <form id="editPaperForm" class="space-y-4">
                <input type="hidden" id="edit-id-paper">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1">Judul Paper (ID)</label>
                        <p id="edit-title-display-paper" class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg font-semibold text-gray-800 truncate"></p>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1" for="edit-deadline-paper">Deadline</label>
                        <input type="date" id="edit-deadline-paper"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1" for="edit-authors-paper">Penulis</label>
                        <input type="text" id="edit-authors-paper" placeholder="Nama Penulis (Pisahkan dengan koma)"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1" for="edit-reference_link-paper">Link Referensi</label>
                        <input type="url" id="edit-reference_link-paper" placeholder="Link Referensi (URL)"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1" for="edit-status-paper">Status (Wajib)</label>
                        <select id="edit-status-paper" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                            <option value="Draft">Draft</option>
                            <option value="Submitted">Submitted</option>
                            <option value="Under Review">Under Review</option>
                            <option value="Accepted">Accepted</option>
                            <option value="Rejected">Rejected</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1" for="edit-overleaf_link-paper">Link Overleaf</label>
                        <input type="url" id="edit-overleaf_link-paper" placeholder="Link Overleaf (URL)"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1" for="edit-category-paper">Kategori</label>
                        <input type="text" id="edit-category-paper" placeholder="Kategori (Jurnal/Konferensi/Lainnya)"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1" for="edit-ppt_link-paper">Link PPT/Slide</label>
                        <input type="url" id="edit-ppt_link-paper" placeholder="Link PPT/Slide (URL)"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                </div>

                <p id="editFormPaperMessage" class="text-sm text-center font-semibold hidden"></p>

                <button type="submit" id="saveEditPaperButton"
                    class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition duration-300 shadow-md disabled:opacity-50 flex items-center justify-center space-x-2">
                    <i data-lucide="check" class="w-5 h-5"></i> <span>Simpan Perubahan</span>
                </button>
            </form>
        </div>
    </div>
    
    <!-- BAGIAN 4: MODAL EDIT MATERI (BARU) -->
    <div id="editMateriModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-yellow-700 mb-4 flex items-center space-x-2 border-b pb-2">
                <i data-lucide="file-edit" class="w-6 h-6"></i>
                <span>Edit Detail Materi</span>
            </h3>
            <button onclick="closeEditModal('materi')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <form id="editMateriForm" class="space-y-4">
                <input type="hidden" id="edit-id-materi">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1">Judul Materi</label>
                        <input type="text" id="edit-judul_materi" placeholder="Judul Materi (Wajib)" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1" for="edit-divisi">Divisi (Wajib)</label>
                        <select id="edit-divisi" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                            <option value="5G">5G</option>
                            <option value="IoT">IoT</option>
                            <option value="Umum">Umum</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1" for="edit-pembuat">Pembuat</label>
                        <input type="text" id="edit-pembuat" placeholder="Nama Pembuat"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1" for="edit-tanggal_jadi">Tanggal Jadi</label>
                        <input type="date" id="edit-tanggal_jadi" placeholder="Tanggal Jadi"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                </div>

                <!-- Link Materi (Full width) -->
                <div>
                    <label class="block text-gray-700 text-sm font-bold mb-1" for="edit-link_materi">Link Materi (Wajib)</label>
                    <input type="url" id="edit-link_materi" placeholder="Link Materi (URL)" required
                        class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                </div>

                <p id="editFormMateriMessage" class="text-sm text-center font-semibold hidden"></p>

                <button type="submit" id="saveEditMateriButton"
                    class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition duration-300 shadow-md disabled:opacity-50 flex items-center justify-center space-x-2">
                    <i data-lucide="check" class="w-5 h-5"></i> <span>Simpan Perubahan Materi</span>
                </button>
            </form>
        </div>
    </div>


    <!-- Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        // --- KONFIGURASI ASET ---
        const LOGO_URL = 'https://raw.githubusercontent.com/fitrasadli/pantaupaper/main/Logo%20Hexacomm.png'; 

        // --- KONFIGURASI SUPABASE ---
        const SUPABASE_URL = 'https://lkldrnughtjtwlbnzrup.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_P3m8csALCDa3-tJvoLhIBQ_AD_UkmDV';
        const TABLE_NAME_PAPER = 'papers';
        const TABLE_NAME_MATERI = 'materi';
        const USER_TABLE_NAME = 'users';

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- REFERENSI DOM ---
        const loginSection = document.getElementById('loginSection');
        const appSection = document.getElementById('appSection');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const logoutButton = document.getElementById('logoutButton');
        const loginLogo = document.getElementById('loginLogo');
        const headerLogo = document.getElementById('headerLogo');

        // Navigasi & View
        const mainNav = document.getElementById('mainNav');
        const paperView = document.getElementById('paperView');
        const materiView = document.getElementById('materiView');

        // Paper Elements
        const papersList = document.getElementById('papersList');
        const paperForm = document.getElementById('paperForm');
        const searchPaperInput = document.getElementById('searchPaper');
        const noPaperDataMessage = document.getElementById('noPaperDataMessage');
        const formPaperMessage = document.getElementById('formPaperMessage');
        const submitPaperButton = document.getElementById('submitPaperButton');
        const editModal = document.getElementById('editModal');
        const editPaperForm = document.getElementById('editPaperForm');
        const editFormPaperMessage = document.getElementById('editFormPaperMessage');
        const saveEditPaperButton = document.getElementById('saveEditPaperButton');

        // Materi Elements
        const materiList = document.getElementById('materiList');
        const materiForm = document.getElementById('materiForm');
        const searchMateriInput = document.getElementById('searchMateri');
        const noMateriDataMessage = document.getElementById('noMateriDataMessage');
        const formMateriMessage = document.getElementById('formMateriMessage');
        const submitMateriButton = document.getElementById('submitMateriButton');
        const editMateriModal = document.getElementById('editMateriModal');
        const editMateriForm = document.getElementById('editMateriForm');
        const editFormMateriMessage = document.getElementById('editFormMateriMessage');
        const saveEditMateriButton = document.getElementById('saveEditMateriButton');

        // Status Sorting Global (Dipisahkan berdasarkan jenis)
        const sortState = {
            paper: { col: 'created_at', order: 'desc' },
            materi: { col: 'created_at', order: 'desc' }
        };
        
        let currentActiveView = 'paper'; // Default view saat login

        // --- LOGIKA UTILITY ---
        function renderButtonContent(text, icon = 'file-plus') {
            const spinClass = icon === 'loader-circle' ? 'animate-spin-fast' : '';
            return `<i data-lucide="${icon}" class="w-5 h-5 mr-2 ${spinClass}"></i> <span>${text}</span>`;
        }

        // --- LOGIKA NAVIGASI DAN VIEW --- 
        
        function showView(viewName) {
            currentActiveView = viewName;
            
            // Sembunyikan semua view dan reset navigasi
            document.querySelectorAll('.view-content').forEach(view => {
                if (view) view.classList.add('hidden');
            });
            document.querySelectorAll('.nav-item').forEach(nav => {
                if (nav) {
                    nav.classList.remove('nav-item-active');
                    nav.classList.add('nav-item-inactive');
                }
            });

            // Tampilkan view yang sesuai dan atur status navigasi
            const targetView = document.getElementById(`${viewName}View`);
            const targetNav = document.getElementById(`nav-${viewName}`);

            if (targetView) targetView.classList.remove('hidden');
            if (targetNav) {
                targetNav.classList.add('nav-item-active');
                targetNav.classList.remove('nav-item-inactive');
            }

            // Muat data untuk view yang aktif
            if (viewName === 'paper') {
                const searchTerm = searchPaperInput ? searchPaperInput.value : '';
                fetchPapers(searchTerm);
            } else if (viewName === 'materi') {
                const searchTerm = searchMateriInput ? searchMateriInput.value : '';
                fetchMateri(searchTerm);
            }
            lucide.createIcons(); // Re-render icons
        }
        
        mainNav && mainNav.addEventListener('click', (e) => {
            const navItem = e.target.closest('.nav-item');
            if (navItem) {
                const view = navItem.getAttribute('data-view');
                showView(view);
            }
        });

        // --- LOGIKA SORTING HEADER UNTUK KEDUA TABEL ---
        
        function updateTableHeaders(type) {
            // Hapus semua ikon sort untuk tipe ini
            document.querySelectorAll(`.sort-icon-wrapper.${type}`).forEach(wrapper => {
                if (wrapper) wrapper.innerHTML = '';
            });

            const state = sortState[type];
            const icon = state.order === 'asc' ? 'arrow-up' : 'arrow-down';
            
            // Cari wrapper ikon untuk kolom yang sedang aktif
            const activeWrapper = document.querySelector(`.sort-icon-wrapper.${type}[data-col="${state.col}"]`);
            if (activeWrapper) {
                activeWrapper.innerHTML = `<i data-lucide="${icon}" class="w-3 h-3 text-yellow-600"></i>`;
                lucide.createIcons();
            }
        }

        window.handleHeaderSortClick = (column, type) => {
            const state = sortState[type];
            
            if (state.col === column) {
                state.order = state.order === 'asc' ? 'desc' : 'asc';
            } else {
                state.col = column;
                state.order = 'asc'; 
            }

            if (type === 'paper') {
                const searchTerm = searchPaperInput ? searchPaperInput.value : '';
                fetchPapers(searchTerm);
            } else if (type === 'materi') {
                const searchTerm = searchMateriInput ? searchMateriInput.value : '';
                fetchMateri(searchTerm);
            }
            updateTableHeaders(type); // Di sini kita panggil untuk update visual segera
        };

        // --- LOGIKA LOGIN (Tidak Berubah) ---
        function setLogos() {
            if (loginLogo) loginLogo.src = LOGO_URL;
            if (headerLogo) headerLogo.src = LOGO_URL; 
        }

        function checkSession() {
            setLogos();
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');
            if (isLoggedIn === 'true') {
                showApp();
                // Tampilkan view default saat login berhasil
                showView(currentActiveView);
            } else {
                showLogin();
            }
        }

        function showLogin() {
            if (loginSection) loginSection.classList.remove('flex-grow', 'hidden');
            if (appSection) appSection.classList.add('hidden');
        }

        function showApp() {
            if (loginSection) loginSection.classList.add('hidden');
            if (appSection) appSection.classList.remove('hidden');
        }

        loginForm && loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const submitBtn = loginForm.querySelector('button[type="submit"]');

            const originalText = submitBtn.innerText;
            submitBtn.disabled = true;
            submitBtn.innerText = "Memeriksa...";
            if (loginError) loginError.classList.add('hidden');

            try {
                const { data, error } = await supabaseClient
                    .from(USER_TABLE_NAME)
                    .select('*')
                    .eq('username', user)
                    .eq('password', pass)
                    .maybeSingle();

                if (error) throw error;

                if (data) {
                    sessionStorage.setItem('isLoggedIn', 'true');
                    showApp();
                    showView(currentActiveView); // Tampilkan view default
                } else {
                    throw new Error("Username atau Password salah!");
                }
            } catch (err) {
                console.error("Login error:", err);
                let errorMessage = "Terjadi kesalahan saat login.";
                if (err.message) {
                    if (err.message.includes('relation "users" does not exist')) {
                        errorMessage = "Error: Tabel 'users' belum dibuat di database.";
                    } else if (err.message.includes('Username atau Password salah')) {
                        errorMessage = err.message;
                    } else {
                        errorMessage = "Terjadi kesalahan koneksi. Periksa konsol untuk detail.";
                    }
                }
                if (loginError) {
                    loginError.textContent = errorMessage;
                    loginError.classList.remove('hidden');
                }
            } finally {
                if (submitBtn) submitBtn.disabled = false;
                if (submitBtn) submitBtn.innerText = originalText;
            }
        });

        logoutButton && logoutButton.addEventListener('click', () => {
            sessionStorage.removeItem('isLoggedIn');
            window.location.reload(); 
        });

        // --- LOGIKA PAPER ---
        
        function getStatusBadge(status) {
            let color = '';
            let icon = '';
            switch (status) {
                case 'Draft': color = 'bg-yellow-100 text-yellow-800 border border-yellow-300'; icon = 'pencil'; break;
                case 'Submitted': color = 'bg-blue-100 text-blue-800 border border-blue-300'; icon = 'send'; break;
                case 'Under Review': color = 'bg-purple-100 text-purple-800 border border-purple-300'; icon = 'search'; break;
                case 'Accepted': color = 'bg-green-100 text-green-800 border border-green-300'; icon = 'check-circle'; break;
                case 'Rejected': color = 'bg-red-100 text-red-800 border border-red-300'; icon = 'x-circle'; break;
                default: color = 'bg-gray-100 text-gray-800 border border-gray-300'; icon = 'file';
            }
            return `

                <span class="px-3 py-1 inline-flex text-xs leading-5 font-bold rounded-full items-center space-x-1 ${color}">
                    <i data-lucide="${icon}" class="w-3 h-3"></i>
                    <span>${status}</span>
                </span>
            `;
        }

        function createPaperRow(paper) {
            const deadlineDate = paper.deadline ? new Date(paper.deadline).toLocaleDateString('id-ID', { year: 'numeric', month: 'short', day: 'numeric' }) : '-';
            const paperJson = JSON.stringify(paper).replace(/'/g, "\\'");

            const linkIcon = (url, iconName, label) => {
                if (!url) return '';
                const safeUrl = url.startsWith('http') || url.startsWith('https') ? url : `https://${url}`;
                return `
                    <a href="${safeUrl}" target="_blank" rel="noopener noreferrer" 
                        class="p-1 rounded-full border border-yellow-200 bg-yellow-50 text-yellow-600 hover:bg-yellow-200 hover:border-yellow-400 transition duration-200 shadow-sm" 
                        title="${label}">
                        <i data-lucide="${iconName}" class="w-4 h-4"></i>
                    </a>
                `;
            };

            const links = `
                ${linkIcon(paper.reference_link, 'link', 'Link Referensi')}
                ${linkIcon(paper.overleaf_link, 'file-text', 'Link Overleaf')}
                ${linkIcon(paper.ppt_link, 'monitor', 'Link PPT')}
            `;

            return `
                <tr class="hover:bg-yellow-50 transition duration-150">
                    <td class="px-3 py-4 whitespace-normal text-sm font-medium text-gray-900">${paper.title}</td>
                    <td class="px-3 py-4 whitespace-normal text-sm text-gray-500">${paper.authors || '-'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm">${getStatusBadge(paper.status)}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell">${paper.category || '-'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell">${deadlineDate}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-700 flex space-x-1 items-center">
                        ${links}
                        <button onclick='openEditModal("paper", ${paperJson})'
                            class="p-1 rounded-full border border-blue-200 bg-blue-50 text-blue-600 hover:bg-blue-200 hover:border-blue-400 transition duration-200 shadow-sm" 
                            title="Edit Paper">
                            <i data-lucide="edit-3" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `;
        }

        async function fetchPapers(searchTerm = '') {
            // PERBAIKAN: Tambahkan null check di awal fungsi
            if (!papersList || !noPaperDataMessage) {
                console.error("Error: Element papersList or noPaperDataMessage not found.");
                return;
            }
            noPaperDataMessage.classList.add('hidden');
            
            const state = sortState.paper;
            
            papersList.innerHTML = `
                <tr>
                    <td colspan="6" class="p-4 text-center text-gray-500 flex items-center justify-center">
                        <i data-lucide="loader-circle" class="w-5 h-5 mr-2 animate-spin-fast"></i>
                        Memuat data paper...
                    </td>
                </tr>
            `;
            lucide.createIcons();
            updateTableHeaders('paper');

            try {
                let query = supabaseClient.from(TABLE_NAME_PAPER)
                    .select('*')
                    .order(state.col, { ascending: state.order === 'asc' }); 

                if (searchTerm) {
                    const searchPattern = `%${searchTerm.toLowerCase()}%`;
                    query = query.or(`title.ilike.${searchPattern},authors.ilike.${searchPattern}`);
                }

                const { data, error } = await query;

                if (error) {
                    let errorMessage = error.message.includes('permission denied')
                        ? `Akses Ditolak (RLS Error). Cek RLS tabel '${TABLE_NAME_PAPER}'.`
                        : `Gagal memuat data: ${error.message}`;
                    papersList.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500 font-bold">${errorMessage}</td></tr>`;
                    throw error;
                }

                papersList.innerHTML = '';
                if (data && data.length > 0) {
                    data.forEach(paper => {
                        papersList.insertAdjacentHTML('beforeend', createPaperRow(paper));
                    });
                    lucide.createIcons(); 
                } else {
                    noPaperDataMessage.classList.remove('hidden');
                }

            } catch (error) {
                console.error('Final fetching paper error:', error.message);
            }
        }

        paperForm && paperForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const newPaper = {
                title: document.getElementById('title').value.trim(),
                authors: document.getElementById('authors').value.trim() || null,
                status: document.getElementById('status').value,
                category: document.getElementById('category').value.trim() || null,
                deadline: document.getElementById('deadline').value || null,
                reference_link: document.getElementById('reference_link').value.trim() || null,
                overleaf_link: document.getElementById('overleaf_link').value.trim() || null,
                ppt_link: document.getElementById('ppt_link').value.trim() || null,
            };

            if (!newPaper.title || !newPaper.status) {
                showMessage(formPaperMessage, 'Judul dan Status wajib diisi!', 'text-red-500');
                return;
            }

            if (submitPaperButton) submitPaperButton.disabled = true;
            if (submitPaperButton) submitPaperButton.innerHTML = renderButtonContent('Menyimpan...', 'loader-circle');
            lucide.createIcons();

            try {
                const { error } = await supabaseClient.from(TABLE_NAME_PAPER).insert([newPaper]);

                if (error) throw error;

                paperForm.reset();
                showMessage(formPaperMessage, 'Paper berhasil ditambahkan!', 'text-green-500');
                
                // Tambahkan null check pada search input
                const paperSearchTerm = searchPaperInput ? searchPaperInput.value : '';
                fetchPapers(paperSearchTerm);

            } catch (error) {
                console.error('Error adding paper:', error.message);
                let errorMessage = error.message.includes('permission denied')
                    ? `Gagal menambahkan paper: Akses Ditolak (RLS Error).`
                    : `Gagal menambahkan paper: ${error.message}`;
                showMessage(formPaperMessage, errorMessage, 'text-red-500');
            } finally {
                if (submitPaperButton) submitPaperButton.disabled = false;
                if (submitPaperButton) submitPaperButton.innerHTML = renderButtonContent('Tambah Paper', 'file-plus');
                lucide.createIcons();
            }
        });
        
        // --- LOGIKA MODAL EDIT PAPER ---
        window.openEditModal = (type, data) => {
            if (type === 'paper') {
                if (document.getElementById('edit-id-paper')) document.getElementById('edit-id-paper').value = data.id;
                if (document.getElementById('edit-title-display-paper')) document.getElementById('edit-title-display-paper').textContent = data.title;
                if (document.getElementById('edit-authors-paper')) document.getElementById('edit-authors-paper').value = data.authors || '';
                if (document.getElementById('edit-status-paper')) document.getElementById('edit-status-paper').value = data.status;
                if (document.getElementById('edit-category-paper')) document.getElementById('edit-category-paper').value = data.category || '';
                
                if (document.getElementById('edit-deadline-paper')) document.getElementById('edit-deadline-paper').value = data.deadline ? data.deadline.split('T')[0] : '';
                
                if (document.getElementById('edit-reference_link-paper')) document.getElementById('edit-reference_link-paper').value = data.reference_link || '';
                if (document.getElementById('edit-overleaf_link-paper')) document.getElementById('edit-overleaf_link-paper').value = data.overleaf_link || '';
                if (document.getElementById('edit-ppt_link-paper')) document.getElementById('edit-ppt_link-paper').value = data.ppt_link || '';

                if (editFormPaperMessage) editFormPaperMessage.classList.add('hidden');
                if (editModal) editModal.classList.remove('hidden');
            } else if (type === 'materi') {
                if (document.getElementById('edit-id-materi')) document.getElementById('edit-id-materi').value = data.id;
                if (document.getElementById('edit-judul_materi')) document.getElementById('edit-judul_materi').value = data.judul_materi;
                if (document.getElementById('edit-divisi')) document.getElementById('edit-divisi').value = data.divisi;
                if (document.getElementById('edit-pembuat')) document.getElementById('edit-pembuat').value = data.pembuat || '';
                if (document.getElementById('edit-tanggal_jadi')) document.getElementById('edit-tanggal_jadi').value = data.tanggal_jadi ? data.tanggal_jadi.split('T')[0] : '';
                if (document.getElementById('edit-link_materi')) document.getElementById('edit-link_materi').value = data.link_materi || '';
                
                if (editFormMateriMessage) editFormMateriMessage.classList.add('hidden');
                if (editMateriModal) editMateriModal.classList.remove('hidden');
            }
            lucide.createIcons();
        }

        window.closeEditModal = (type) => {
            if (type === 'paper') {
                if (editModal) editModal.classList.add('hidden');
            } else if (type === 'materi') {
                if (editMateriModal) editMateriModal.classList.add('hidden');
            }
        }
        
        editPaperForm && editPaperForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const paperId = document.getElementById('edit-id-paper').value;
            const updatedPaper = {
                authors: document.getElementById('edit-authors-paper').value.trim() || null,
                status: document.getElementById('edit-status-paper').value,
                category: document.getElementById('edit-category-paper').value.trim() || null,
                deadline: document.getElementById('edit-deadline-paper').value || null,
                reference_link: document.getElementById('edit-reference_link-paper').value.trim() || null,
                overleaf_link: document.getElementById('edit-overleaf_link-paper').value.trim() || null,
                ppt_link: document.getElementById('edit-ppt_link-paper').value.trim() || null,
            };

            if (saveEditPaperButton) saveEditPaperButton.disabled = true;
            if (saveEditPaperButton) saveEditPaperButton.innerHTML = renderButtonContent('Menyimpan...', 'loader-circle');
            lucide.createIcons();

            try {
                const { error } = await supabaseClient
                    .from(TABLE_NAME_PAPER)
                    .update(updatedPaper)
                    .eq('id', paperId);

                if (error) throw error;

                showMessage(editFormPaperMessage, 'Perubahan berhasil disimpan!', 'text-green-500');
                
                // Tambahkan null check pada search input
                const paperSearchTerm = searchPaperInput ? searchPaperInput.value : '';
                fetchPapers(paperSearchTerm);

                setTimeout(closeEditModal.bind(null, 'paper'), 1000);

            } catch (error) {
                console.error('Error updating paper:', error.message);
                let errorMessage = error.message.includes('permission denied')
                    ? `Gagal menyimpan: Akses Ditolak (RLS Error).`
                    : `Gagal menyimpan: ${error.message}`;
                showMessage(editFormPaperMessage, errorMessage, 'text-red-500');
            } finally {
                if (saveEditPaperButton) saveEditPaperButton.disabled = false;
                if (saveEditPaperButton) saveEditPaperButton.innerHTML = renderButtonContent('Simpan Perubahan', 'check');
                lucide.createIcons();
            }
        });


        // --- LOGIKA MATERI BARU ---
        
        function createMateriRow(materi) {
            const tanggalJadi = materi.tanggal_jadi ? new Date(materi.tanggal_jadi).toLocaleDateString('id-ID', { year: 'numeric', month: 'short', day: 'numeric' }) : '-';
            const materiJson = JSON.stringify(materi).replace(/'/g, "\\'");
            
            const badgeColor = materi.divisi === '5G' ? 'bg-indigo-100 text-indigo-800' : 
                               materi.divisi === 'IoT' ? 'bg-cyan-100 text-cyan-800' : 'bg-gray-100 text-gray-800';

            return `
                <tr class="hover:bg-yellow-50 transition duration-150">
                    <td class="px-3 py-4 whitespace-normal text-sm font-medium text-gray-900">${materi.judul_materi}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm">
                        <span class="px-3 py-1 inline-flex text-xs leading-5 font-bold rounded-full ${badgeColor}">
                            ${materi.divisi}
                        </span>
                    </td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell">${materi.pembuat || '-'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell">${tanggalJadi}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-700 flex space-x-1 items-center">
                        <a href="${materi.link_materi}" target="_blank" rel="noopener noreferrer" 
                            class="p-1 rounded-full border border-yellow-200 bg-yellow-50 text-yellow-600 hover:bg-yellow-200 hover:border-yellow-400 transition duration-200 shadow-sm" 
                            title="Akses Materi">
                            <i data-lucide="link" class="w-4 h-4"></i>
                        </a>
                        <button onclick='openEditModal("materi", ${materiJson})'
                            class="p-1 rounded-full border border-blue-200 bg-blue-50 text-blue-600 hover:bg-blue-200 hover:border-blue-400 transition duration-200 shadow-sm" 
                            title="Edit Materi">
                            <i data-lucide="edit-3" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `;
        }

        async function fetchMateri(searchTerm = '') {
            // PERBAIKAN: Tambahkan null check di awal fungsi
            if (!materiList || !noMateriDataMessage) {
                console.error("Error: Element materiList or noMateriDataMessage not found.");
                return;
            }
            noMateriDataMessage.classList.add('hidden');

            const state = sortState.materi;

            materiList.innerHTML = `
                <tr>
                    <td colspan="5" class="p-4 text-center text-gray-500 flex items-center justify-center">
                        <i data-lucide="loader-circle" class="w-5 h-5 mr-2 animate-spin-fast"></i>
                        Memuat data materi...
                    </td>
                </tr>
            `;
            lucide.createIcons();
            updateTableHeaders('materi');

            try {
                let query = supabaseClient.from(TABLE_NAME_MATERI)
                    .select('*')
                    .order(state.col, { ascending: state.order === 'asc' });

                if (searchTerm) {
                    const searchPattern = `%${searchTerm.toLowerCase()}%`;
                    query = query.or(`judul_materi.ilike.${searchPattern},pembuat.ilike.${searchPattern}`);
                }

                const { data, error } = await query;

                if (error) {
                    let errorMessage = error.message.includes('relation "materi" does not exist')
                        ? `Error: Tabel 'materi' belum dibuat di database. Silakan buat tabel materi (Lihat file SQL).`
                            : (error.message.includes('permission denied')
                            ? `Akses Ditolak (RLS Error). Cek RLS tabel '${TABLE_NAME_MATERI}'.`
                            : `Gagal memuat data: ${error.message}`);
                    materiList.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-500 font-bold">${errorMessage}</td></tr>`;
                    throw error;
                }

                materiList.innerHTML = '';
                if (data && data.length > 0) {
                    data.forEach(materi => {
                        materiList.insertAdjacentHTML('beforeend', createMateriRow(materi));
                    });
                    lucide.createIcons();
                } else {
                    noMateriDataMessage.classList.remove('hidden');
                }

            } catch (error) {
                console.error('Final fetching materi error:', error.message);
            }
        }

        materiForm && materiForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const newMateri = {
                divisi: document.getElementById('divisi').value,
                judul_materi: document.getElementById('judul_materi').value.trim(),
                pembuat: document.getElementById('pembuat').value.trim() || null,
                tanggal_jadi: document.getElementById('tanggal_jadi').value || null,
                link_materi: document.getElementById('link_materi').value.trim(),
            };

            if (!newMateri.divisi || !newMateri.judul_materi || !newMateri.link_materi) {
                showMessage(formMateriMessage, 'Divisi, Judul, dan Link Materi wajib diisi!', 'text-red-500');
                return;
            }
            
            if (submitMateriButton) submitMateriButton.disabled = true;
            if (submitMateriButton) submitMateriButton.innerHTML = renderButtonContent('Menyimpan...', 'loader-circle');
            lucide.createIcons();

            try {
                const { error } = await supabaseClient.from(TABLE_NAME_MATERI).insert([newMateri]);

                if (error) throw error;

                materiForm.reset();
                showMessage(formMateriMessage, 'Materi berhasil ditambahkan!', 'text-green-500');
                
                // Tambahkan null check pada search input
                const materiSearchTerm = searchMateriInput ? searchMateriInput.value : '';
                fetchMateri(materiSearchTerm);

            } catch (error) {
                console.error('Error adding materi:', error.message);
                let errorMessage = error.message.includes('permission denied')
                    ? `Gagal menambahkan materi: Akses Ditolak (RLS Error).`
                    : `Gagal menambahkan materi: ${error.message}`;
                showMessage(formMateriMessage, errorMessage, 'text-red-500');
            } finally {
                if (submitMateriButton) submitMateriButton.disabled = false;
                if (submitMateriButton) submitMateriButton.innerHTML = renderButtonContent('Tambah Materi', 'folder-plus');
                lucide.createIcons();
            }
        });

        editMateriForm && editMateriForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const materiId = document.getElementById('edit-id-materi').value;
            const updatedMateri = {
                divisi: document.getElementById('edit-divisi').value,
                judul_materi: document.getElementById('edit-judul_materi').value.trim(),
                pembuat: document.getElementById('edit-pembuat').value.trim() || null,
                tanggal_jadi: document.getElementById('edit-tanggal_jadi').value || null,
                link_materi: document.getElementById('edit-link_materi').value.trim(),
            };

            if (!updatedMateri.divisi || !updatedMateri.judul_materi || !updatedMateri.link_materi) {
                showMessage(editFormMateriMessage, 'Divisi, Judul, dan Link Materi wajib diisi!', 'text-red-500');
                return;
            }

            if (saveEditMateriButton) saveEditMateriButton.disabled = true;
            if (saveEditMateriButton) saveEditMateriButton.innerHTML = renderButtonContent('Menyimpan...', 'loader-circle');
            lucide.createIcons();

            try {
                const { error } = await supabaseClient
                    .from(TABLE_NAME_MATERI)
                    .update(updatedMateri)
                    .eq('id', materiId);

                if (error) throw error;

                showMessage(editFormMateriMessage, 'Perubahan berhasil disimpan!', 'text-green-500');
                
                // Tambahkan null check pada search input
                const materiSearchTerm = searchMateriInput ? searchMateriInput.value : '';
                fetchMateri(materiSearchTerm);

                setTimeout(closeEditModal.bind(null, 'materi'), 1000);

            } catch (error) {
                console.error('Error updating materi:', error.message);
                let errorMessage = error.message.includes('permission denied')
                    ? `Gagal menyimpan: Akses Ditolak (RLS Error).`
                    : `Gagal menyimpan: ${error.message}`;
                showMessage(editFormMateriMessage, errorMessage, 'text-red-500');
            } finally {
                if (saveEditMateriButton) saveEditMateriButton.disabled = false;
                if (saveEditMateriButton) saveEditMateriButton.innerHTML = renderButtonContent('Simpan Perubahan Materi', 'check');
                lucide.createIcons();
            }
        });


        // --- UTILITY PESAN & EVENT LISTENER PENCARIAN ---

        function showMessage(element, message, colorClass) {
            if (!element) return; // Tambahkan null check di sini
            element.textContent = message;
            element.className = `col-span-3 text-sm text-center font-semibold ${colorClass}`;
            element.classList.remove('hidden');
            setTimeout(() => {
                element.classList.add('hidden');
            }, 4000);
        }

        let searchTimeout;
        const setupSearchListeners = () => {
            searchPaperInput && searchPaperInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    fetchPapers(searchPaperInput.value);
                }, 300);
            });

            searchMateriInput && searchMateriInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    fetchMateri(searchMateriInput.value);
                }, 300);
            });
        };

        // --- INISIALISASI ---

        document.addEventListener('DOMContentLoaded', () => {
            if (submitPaperButton) submitPaperButton.innerHTML = renderButtonContent('Tambah Paper', 'file-plus');
            if (submitMateriButton) submitMateriButton.innerHTML = renderButtonContent('Tambah Materi', 'folder-plus');
            
            setupSearchListeners();
            checkSession();
            lucide.createIcons();
        });

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Paper Akademik</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        .container {
            max-width: 1280px;
        }
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="container mx-auto">
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 mb-8 border-b-4 border-yellow-600 pb-2">
            Sistem Manajemen Paper
        </h1>

        <!-- Form Tambah Paper -->
        <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold text-yellow-700 mb-4">Tambah Paper Baru</h2>
            <form id="paperForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="text" id="title" placeholder="Judul Paper (Wajib)" required
                       class="col-span-1 md:col-span-2 p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                <input type="text" id="authors" placeholder="Nama Penulis (Pisahkan dengan koma)"
                       class="p-3 border border-gray-300 rounded-lg">
                <select id="status" required
                        class="p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                    <option value="" disabled selected>Pilih Status</option>
                    <option value="Draft">Draft</option>
                    <option value="Submitted">Submitted</option>
                    <option value="Under Review">Under Review</option>
                    <option value="Accepted">Accepted</option>
                    <option value="Rejected">Rejected</option>
                </select>
                <input type="text" id="category" placeholder="Kategori (Jurnal/Konferensi/Lainnya)"
                       class="p-3 border border-gray-300 rounded-lg">
                <input type="date" id="deadline" placeholder="Deadline"
                       class="p-3 border border-gray-300 rounded-lg">
                <input type="url" id="reference_link" placeholder="Link Referensi (URL)"
                       class="p-3 border border-gray-300 rounded-lg">
                <input type="url" id="overleaf_link" placeholder="Link Overleaf (URL)"
                       class="p-3 border border-gray-300 rounded-lg">
                <input type="url" id="ppt_link" placeholder="Link PPT/Slide (URL)"
                       class="p-3 border border-gray-300 rounded-lg">
                
                <button type="submit" id="submitButton"
                        class="col-span-1 md:col-span-3 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-lg transition duration-300 shadow-md hover:shadow-lg disabled:opacity-50">
                    Tambah Paper
                </button>
                <p id="formMessage" class="col-span-3 text-sm text-center hidden"></p>
            </form>
        </div>

        <!-- Bagian Pencarian dan Daftar Paper -->
        <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold text-yellow-700 mb-4">Daftar Paper</h2>
            
            <!-- Input Pencarian -->
            <input type="text" id="search" placeholder="Cari berdasarkan Judul atau Penulis..."
                   class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">

            <!-- Tabel Paper -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Judul</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Penulis</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Kategori</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Deadline</th>
                            <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tautan</th>
                        </tr>
                    </thead>
                    <tbody id="papersList" class="bg-white divide-y divide-gray-200">
                        <!-- Data paper akan dimasukkan di sini oleh JavaScript -->
                        <tr id="loadingRow">
                            <td colspan="6" class="p-4 text-center text-gray-500">Memuat data...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
             <p id="noDataMessage" class="hidden p-4 text-center text-gray-500 mt-4">Tidak ada paper yang ditemukan.</p>
        </div>

    </div>

    <!-- Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        // --- KONFIGURASI SUPABASE (Gunakan data dari input pengguna) ---
        const SUPABASE_URL = 'https://lkldrnughtjtwlbnzrup.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_P3m8csALCDa3-tJvoLhIBQ_AD_UkmDV';
        const TABLE_NAME = 'papers';

        // Perbaikan: Mengganti nama variabel klien Supabase menjadi 'supabaseClient'
        // untuk menghindari bentrok dengan objek global 'supabase' dari CDN saat inisialisasi.
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- REFERENSI DOM ---
        const papersList = document.getElementById('papersList');
        const paperForm = document.getElementById('paperForm');
        const searchInput = document.getElementById('search');
        const loadingRow = document.getElementById('loadingRow');
        const noDataMessage = document.getElementById('noDataMessage');
        const formMessage = document.getElementById('formMessage');
        const submitButton = document.getElementById('submitButton');

        // --- FUNGSI UTAMA ---

        /**
         * Mengubah status menjadi badge Tailwind CSS
         * @param {string} status
         * @returns {string} HTML untuk badge
         */
        function getStatusBadge(status) {
            let color = '';
            switch (status) {
                case 'Draft':
                    color = 'bg-yellow-100 text-yellow-800';
                    break;
                case 'Submitted':
                    color = 'bg-blue-100 text-blue-800';
                    break;
                case 'Under Review':
                    color = 'bg-purple-100 text-purple-800';
                    break;
                case 'Accepted':
                    color = 'bg-green-100 text-green-800';
                    break;
                case 'Rejected':
                    color = 'bg-red-100 text-red-800';
                    break;
                default:
                    color = 'bg-gray-100 text-gray-800';
            }
            return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${color}">${status}</span>`;
        }

        /**
         * Membuat baris tabel untuk satu paper
         * @param {object} paper
         * @returns {string} HTML untuk baris tabel
         */
        function createPaperRow(paper) {
            const deadlineDate = paper.deadline ? new Date(paper.deadline).toLocaleDateString('id-ID') : '-';

            const linkIcon = (url, iconName, label) => {
                if (!url) return '';
                return `
                    <a href="${url}" target="_blank" rel="noopener noreferrer" 
                       class="text-gray-500 hover:text-yellow-600 transition duration-150 mx-0.5" 
                       title="${label}">
                        <i data-lucide="${iconName}" class="w-5 h-5"></i>
                    </a>
                `;
            };

            const links = `
                ${linkIcon(paper.reference_link, 'link', 'Link Referensi')}
                ${linkIcon(paper.overleaf_link, 'file-text', 'Link Overleaf')}
                ${linkIcon(paper.ppt_link, 'monitor', 'Link PPT')}
            `;
            
            return `
                <tr class="hover:bg-yellow-50 transition duration-150">
                    <td class="px-3 py-4 whitespace-normal text-sm font-medium text-gray-900">${paper.title}</td>
                    <td class="px-3 py-4 whitespace-normal text-sm text-gray-500">${paper.authors || '-'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm">${getStatusBadge(paper.status)}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell">${paper.category || '-'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell">${deadlineDate}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-700 flex space-x-1 items-center">
                        ${links}
                    </td>
                </tr>
            `;
        }
        
        /**
         * Mengambil data paper dari Supabase
         * @param {string} searchTerm - Kata kunci pencarian
         */
        async function fetchPapers(searchTerm = '') {
            loadingRow.classList.remove('hidden');
            papersList.innerHTML = '';
            noDataMessage.classList.add('hidden');

            try {
                // Menggunakan supabaseClient yang sudah diperbaiki
                let query = supabaseClient.from(TABLE_NAME)
                    .select('*')
                    .order('created_at', { ascending: false });

                // Terapkan filter pencarian jika ada
                if (searchTerm) {
                    const searchPattern = `%${searchTerm.toLowerCase()}%`;
                    // Cari di kolom title ATAU authors
                    query = query.or(`title.ilike.${searchPattern},authors.ilike.${searchPattern}`);
                }

                const { data, error } = await query;

                if (error) {
                    throw error;
                }

                papersList.innerHTML = ''; // Kosongkan daftar
                if (data && data.length > 0) {
                    data.forEach(paper => {
                        papersList.insertAdjacentHTML('beforeend', createPaperRow(paper));
                    });
                     // Setelah data dimasukkan, proses ikon Lucide
                    lucide.createIcons();
                } else {
                    noDataMessage.classList.remove('hidden');
                }

            } catch (error) {
                console.error('Error fetching papers:', error.message);
                papersList.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500">Gagal memuat data: ${error.message}</td></tr>`;
            } finally {
                loadingRow.classList.add('hidden');
            }
        }

        /**
         * Menambahkan paper baru ke Supabase
         */
        async function addPaper(event) {
            event.preventDefault();

            const newPaper = {
                title: document.getElementById('title').value.trim(),
                authors: document.getElementById('authors').value.trim(),
                status: document.getElementById('status').value,
                category: document.getElementById('category').value.trim() || null,
                deadline: document.getElementById('deadline').value || null,
                reference_link: document.getElementById('reference_link').value.trim() || null,
                overleaf_link: document.getElementById('overleaf_link').value.trim() || null,
                ppt_link: document.getElementById('ppt_link').value.trim() || null,
            };

            if (!newPaper.title || !newPaper.status) {
                showMessage('Judul dan Status wajib diisi!', 'text-red-500');
                return;
            }

            submitButton.disabled = true;
            submitButton.textContent = 'Menyimpan...';

            try {
                // Menggunakan supabaseClient yang sudah diperbaiki
                const { error } = await supabaseClient.from(TABLE_NAME).insert([newPaper]);

                if (error) {
                    throw error;
                }

                // Sukses
                paperForm.reset();
                showMessage('Paper berhasil ditambahkan!', 'text-green-500');
                // Data akan otomatis diupdate karena kita menggunakan onSnapshot (atau dipanggil ulang)
                fetchPapers(searchInput.value);

            } catch (error) {
                console.error('Error adding paper:', error.message);
                showMessage(`Gagal menambahkan paper: ${error.message}`, 'text-red-500');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Tambah Paper';
            }
        }

        /**
         * Menampilkan pesan sementara di bawah form
         * @param {string} message 
         * @param {string} colorClass 
         */
        function showMessage(message, colorClass) {
            formMessage.textContent = message;
            formMessage.className = `col-span-3 text-sm text-center ${colorClass}`;
            formMessage.classList.remove('hidden');
            setTimeout(() => {
                formMessage.classList.add('hidden');
            }, 3000);
        }

        // --- EVENT LISTENERS ---

        paperForm.addEventListener('submit', addPaper);

        // Debounce untuk fungsi pencarian agar tidak memanggil API terlalu sering
        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                fetchPapers(searchInput.value);
            }, 300); // Tunggu 300ms setelah user berhenti mengetik
        });

        // --- INISIALISASI ---

        document.addEventListener('DOMContentLoaded', () => {
            // Muat data awal saat halaman dimuat
            fetchPapers();
        });

        // Catatan: Untuk aplikasi real-time yang lebih baik,
        // gunakan `supabase.channel('public:papers').on('postgres_changes', ...).subscribe()`
        // namun, untuk kesederhanaan file tunggal, kita menggunakan pemanggilan ulang `fetchPapers()`
        // setelah penambahan data.

    </script>
</body>
</html>

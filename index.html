<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Paper Akademik</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* Default background for app section - PUTIH */
            background-color: #ffffff;
        }
        .container {
            max-width: 1280px;
        }
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        /* Style for the visual side - SANGAT LEMBUT/PUTIH */
        #visual-side {
            background: linear-gradient(135deg, #fffcf5, #ffffff); /* Soft Yellowish White ke Pure White */
            color: #4b5563; /* Warna teks dipertahankan */
        }
        /* Keyframe for loading animation */
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
        .animate-spin-fast {
          animation: spin 0.5s linear infinite;
        }

        /* Gaya untuk Modal (Jendela Pop-up) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 90%;
            width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            position: relative;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- BAGIAN 1: LOGIN SECTION -->
    <div id="loginSection" class="flex-grow flex items-center justify-center p-4">
        <div class="w-full max-w-sm md:max-w-4xl lg:max-w-5xl flex rounded-2xl shadow-2xl overflow-hidden">
            
            <!-- Left Side: Visual/Logo -->
            <div id="visual-side" class="hidden md:block md:w-1/2 p-12 relative flex flex-col justify-center items-center">
                <div class="text-center">
                    <!-- LOGO DI SINI -->
                    <img id="loginLogo" 
                        class="max-w-[150px] h-auto mx-auto mb-4 p-3 rounded-xl shadow-lg object-contain border border-yellow-100" 
                        src="" 
                        alt="Logo Hexacomm.png"
                        onerror="this.onerror=null; this.src='https://placehold.co/150x150/fde047/78350f?text=Hexa';">
                    <!-- AKHIR LOGO -->

                    <h2 class="text-3xl font-extrabold mb-2 text-yellow-700">Paper Riset Hexacomm</h2>
                    <p class="mt-4 leading-relaxed text-gray-600">
                        Website pemantau paper kalian.
                    </p>
                    <div class="mt-8">
                        <span class="text-sm font-semibold border-b-2 border-yellow-700 text-yellow-800">#HexaRnd</span>
                    </div>
                </div>
            </div>

            <!-- Right Side: Login Form -->
            <div class="w-full md:w-1/2 bg-white p-8 md:p-10 lg:p-12">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800">Masukkan ID Anda</h1>
                    <p class="text-gray-500 text-sm mt-2">Belum ada? tanya RnD</p>
                </div>

                <form id="loginForm" class="space-y-6">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="username">Username</label>
                        <input type="text" id="username" placeholder="Masukkan username" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="password">Password</label>
                        <input type="password" id="password" placeholder="Masukkan password" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-500">
                    </div>
                    
                    <button type="submit" 
                        class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-lg transition duration-300 shadow-lg disabled:opacity-50">
                        Masuk
                    </button>
                </form>
                <p id="loginError" class="text-red-500 text-center mt-6 text-sm hidden"></p>
            </div>
        </div>
    </div>

    <!-- BAGIAN 2: APLIKASI UTAMA (Diperbarui) -->
    <div id="appSection" class="hidden p-4 md:p-8"> <!-- Mewarisi background putih dari body -->
        <div class="container mx-auto">
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 border-b-4 border-yellow-600 pb-2">
                <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 flex items-center space-x-2">
                    <!-- Logo di Header Aplikasi Utama -->
                    <img id="headerLogo" 
                        class="w-8 h-8 mr-2 object-contain rounded-md" 
                        src="" 
                        alt="Logo"
                        onerror="this.onerror=null; this.src='https://placehold.co/32x32/fde047/78350f?text=H';">
                    <span class="text-yellow-600">Sistem Manajemen Paper</span>
                </h1>
                <button id="logoutButton" class="mt-4 md:mt-0 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition shadow flex items-center space-x-1">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    <span>Logout</span>
                </button>
            </div>

            <!-- Form Tambah Paper -->
            <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg mb-8 border-t-4 border-yellow-500">
                <h2 class="text-2xl font-semibold text-yellow-700 mb-4 flex items-center space-x-2">
                    <i data-lucide="book-plus" class="w-6 h-6"></i>
                    <span>Tambah Paper Baru</span>
                </h2>
                <form id="paperForm" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <input type="text" id="title" placeholder="Judul Paper (Wajib)" required
                               class="col-span-1 md:col-span-2 p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                    <input type="text" id="authors" placeholder="Nama Penulis (Pisahkan dengan koma)"
                               class="p-3 border border-gray-300 rounded-lg">
                    <select id="status" required
                                 class="p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                        <option value="" disabled selected>Pilih Status</option>
                        <option value="Draft">Draft</option>
                        <option value="Submitted">Submitted</option>
                        <option value="Under Review">Under Review</option>
                        <option value="Accepted">Accepted</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                    <input type="text" id="category" placeholder="Kategori (Jurnal/Konferensi/Lainnya)"
                               class="p-3 border border-gray-300 rounded-lg">
                    <input type="date" id="deadline" placeholder="Deadline"
                               class="p-3 border border-gray-300 rounded-lg">
                    <input type="url" id="reference_link" placeholder="Link Referensi (URL)"
                               class="p-3 border border-gray-300 rounded-lg">
                    <input type="url" id="overleaf_link" placeholder="Link Overleaf (URL)"
                               class="p-3 border border-gray-300 rounded-lg">
                    <input type="url" id="ppt_link" placeholder="Link PPT/Slide (URL)"
                               class="p-3 border border-gray-300 rounded-lg">
                    
                    <!-- TOMBOL SUBMIT DENGAN VISUAL YANG DIPERBARUI -->
                    <button type="submit" id="submitButton"
                                class="col-span-1 md:col-span-3 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-xl transition duration-300 shadow-xl shadow-yellow-400/50 hover:shadow-2xl hover:shadow-yellow-500/70 disabled:opacity-50 flex items-center justify-center space-x-2">
                        <!-- Konten diisi oleh JS -->
                    </button>
                    <p id="formMessage" class="col-span-3 text-sm text-center hidden"></p>
                </form>
            </div>

            <!-- Bagian Pencarian dan Daftar Paper -->
            <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold text-yellow-700 mb-4 flex items-center space-x-2">
                    <i data-lucide="list-checks" class="w-6 h-6"></i>
                    <span>Daftar Paper</span>
                </h2>
                
                <!-- Input Pencarian -->
                <input type="text" id="search" placeholder="Cari berdasarkan Judul atau Penulis..."
                               class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">

                <!-- Tabel Paper -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Judul</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Penulis</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Kategori</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider hidden sm:table-cell">Deadline</th>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="papersList" class="bg-white divide-y divide-gray-200">
                            <!-- Data paper akan dimasukkan di sini oleh JavaScript -->
                            <tr id="loadingRow">
                                <td colspan="6" class="p-4 text-center text-gray-500">Memuat data...</td>
                            </tr>
                        </tbody>
                    </table>
                       <p id="noDataMessage" class="hidden p-4 text-center text-gray-500 mt-4">Tidak ada paper yang ditemukan.</p>
            </div>
        </div>
    </div>

    <!-- BAGIAN 3: MODAL EDIT PAPER (BARU) -->
    <div id="editModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-2xl font-bold text-yellow-700 mb-4 flex items-center space-x-2 border-b pb-2">
                <i data-lucide="file-edit" class="w-6 h-6"></i>
                <span>Edit Detail Paper</span>
            </h3>
            <button onclick="closeEditModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i data-lucide="x" class="w-6 h-6"></i>
            </button>
            <form id="editPaperForm" class="space-y-4">
                <input type="hidden" id="edit-id">
                
                <!-- CONTAINER GRID DUA KOLOM -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    
                    <!-- BARIS 1: Judul Paper (Display) & Deadline -->
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1">Judul Paper (ID)</label>
                        <p id="edit-title-display" class="w-full p-3 bg-gray-100 border border-gray-300 rounded-lg font-semibold text-gray-800 truncate"></p>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1" for="edit-deadline">Deadline</label>
                        <input type="date" id="edit-deadline"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                    </div>

                    <!-- BARIS 2: Penulis & Link Referensi -->
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1" for="edit-authors">Penulis</label>
                        <input type="text" id="edit-authors" placeholder="Nama Penulis (Pisahkan dengan koma)"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1" for="edit-reference_link">Link Referensi</label>
                        <input type="url" id="edit-reference_link" placeholder="Link Referensi (URL)"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                    </div>

                    <!-- BARIS 3: Status & Link Overleaf -->
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1" for="edit-status">Status (Wajib)</label>
                        <select id="edit-status" required
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                            <option value="Draft">Draft</option>
                            <option value="Submitted">Submitted</option>
                            <option value="Under Review">Under Review</option>
                            <option value="Accepted">Accepted</option>
                            <option value="Rejected">Rejected</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1" for="edit-overleaf_link">Link Overleaf</label>
                        <input type="url" id="edit-overleaf_link" placeholder="Link Overleaf (URL)"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                    </div>

                    <!-- BARIS 4: Kategori & Link PPT/Slide -->
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1" for="edit-category">Kategori</label>
                        <input type="text" id="edit-category" placeholder="Kategori (Jurnal/Konferensi/Lainnya)"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-1" for="edit-ppt_link">Link PPT/Slide</label>
                        <input type="url" id="edit-ppt_link" placeholder="Link PPT/Slide (URL)"
                            class="w-full p-3 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500">
                    </div>
                </div>

                <!-- Pesan dan Tombol Aksi (Full width) -->
                <p id="editFormMessage" class="text-sm text-center font-semibold hidden"></p>

                <button type="submit" id="saveEditButton"
                    class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition duration-300 shadow-md disabled:opacity-50 flex items-center justify-center space-x-2">
                    <i data-lucide="check" class="w-5 h-5"></i> <span>Simpan Perubahan</span>
                </button>
            </form>
        </div>
    </div>


    <!-- Supabase Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        // --- KONFIGURASI ASET ---
        // URL GITHUB RAW (MENTAH) DARI LOGO ANDA
        const LOGO_URL = 'https://raw.githubusercontent.com/fitrasadli/pantaupaper/main/Logo%20Hexacomm.png'; 

        // --- KONFIGURASI SUPABASE ---
        const SUPABASE_URL = 'https://lkldrnughtjtwlbnzrup.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_P3m8csALCDa3-tJvoLhIBQ_AD_UkmDV';
        const TABLE_NAME = 'papers';
        const USER_TABLE_NAME = 'users';

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- REFERENSI DOM ---
        // Login Elements
        const loginSection = document.getElementById('loginSection');
        const appSection = document.getElementById('appSection');
        const loginForm = document.getElementById('loginForm');
        const loginError = document.getElementById('loginError');
        const logoutButton = document.getElementById('logoutButton');

        // Logo Elements
        const loginLogo = document.getElementById('loginLogo');
        const headerLogo = document.getElementById('headerLogo');

        // App Elements
        const papersList = document.getElementById('papersList');
        const paperForm = document.getElementById('paperForm');
        const searchInput = document.getElementById('search');
        const noDataMessage = document.getElementById('noDataMessage');
        const formMessage = document.getElementById('formMessage');
        const submitButton = document.getElementById('submitButton');
        
        // Modal Elements
        const editModal = document.getElementById('editModal');
        const editPaperForm = document.getElementById('editPaperForm');
        const editFormMessage = document.getElementById('editFormMessage');
        const saveEditButton = document.getElementById('saveEditButton');


        // --- LOGIKA LOGIN ---

        // Fungsi untuk mengatur URL logo
        function setLogos() {
            loginLogo.src = LOGO_URL;
            // Gunakan logo yang sama atau versi yang berbeda untuk header
            headerLogo.src = LOGO_URL; 
        }

        // Cek sesi saat halaman dimuat
        function checkSession() {
            setLogos(); // Atur logo saat pertama kali dimuat
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');
            if (isLoggedIn === 'true') {
                showApp();
                // Panggil fetchPapers saat sesi ditemukan (page refresh)
                fetchPapers(); 
            } else {
                showLogin();
            }
        }

        function showLogin() {
            loginSection.classList.remove('hidden');
            appSection.classList.add('hidden');
            // Hanya menghapus kelas gelap jika ada, membiarkan CSS default berlaku
            document.body.classList.remove('bg-gray-900'); 
        }

        function showApp() {
            loginSection.classList.add('hidden');
            appSection.classList.remove('hidden');
            // Hanya menghapus kelas gelap jika ada, membiarkan CSS default (#ffffff) berlaku
            document.body.classList.remove('bg-gray-900');
        }

        // Event Listener Login yang Diperbarui (Menggunakan Database)
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const submitBtn = loginForm.querySelector('button[type="submit"]');

            // Feedback visual loading
            const originalText = submitBtn.innerText;
            submitBtn.disabled = true;
            submitBtn.innerText = "Memeriksa...";
            loginError.classList.add('hidden');

            try {
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .eq('username', user)
                    .eq('password', pass)
                    .maybeSingle();

                if (error) {
                    throw error;
                }

                if (data) {
                    // Login Sukses
                    sessionStorage.setItem('isLoggedIn', 'true');
                    showApp();
                    // Panggil fetchPapers setelah login sukses
                    fetchPapers(); 
                } else {
                    // Login Gagal (User tidak ditemukan atau password salah)
                    throw new Error("Username atau Password salah!");
                }
            } catch (err) {
                console.error("Login error:", err);
                // Menangani pesan error
                let errorMessage = "Terjadi kesalahan saat login.";
                if (err.message) {
                    if (err.message.includes('relation "users" does not exist')) {
                        errorMessage = "Error: Tabel 'users' belum dibuat di database. Silakan buat tabel users dengan kolom username dan password.";
                    } else if (err.message.includes('Username atau Password salah')) {
                        errorMessage = err.message;
                    } else {
                        errorMessage = "Terjadi kesalahan koneksi. Periksa konsol untuk detail.";
                    }
                }
                loginError.textContent = errorMessage;
                loginError.classList.remove('hidden');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerText = originalText;
            }
        });

        logoutButton.addEventListener('click', () => {
            sessionStorage.removeItem('isLoggedIn');
            window.location.reload(); // Reload halaman untuk reset state
        });

        // --- LOGIKA APLIKASI (PAPER) ---
        
        // Helper function for Submit Button content
        function renderSubmitButton(text, icon = 'file-plus') {
            const spinClass = icon === 'loader-circle' ? 'animate-spin-fast' : '';
            return `<i data-lucide="${icon}" class="w-5 h-5 mr-2 ${spinClass}"></i> <span>${text}</span>`;
        }
        
        // Helper function for Edit Button content
        function renderSaveButton(text, icon = 'check') {
            const spinClass = icon === 'loader-circle' ? 'animate-spin-fast' : '';
            return `<i data-lucide="${icon}" class="w-5 h-5 mr-2 ${spinClass}"></i> <span>${text}</span>`;
        }

        // FUNGSI GET STATUS BADGE DENGAN IKON BARU
        function getStatusBadge(status) {
            let color = '';
            let icon = '';
            switch (status) {
                case 'Draft': color = 'bg-yellow-100 text-yellow-800 border border-yellow-300'; icon = 'pencil'; break;
                case 'Submitted': color = 'bg-blue-100 text-blue-800 border border-blue-300'; icon = 'send'; break;
                case 'Under Review': color = 'bg-purple-100 text-purple-800 border border-purple-300'; icon = 'search'; break;
                case 'Accepted': color = 'bg-green-100 text-green-800 border border-green-300'; icon = 'check-circle'; break;
                case 'Rejected': color = 'bg-red-100 text-red-800 border border-red-300'; icon = 'x-circle'; break;
                default: color = 'bg-gray-100 text-gray-800 border border-gray-300'; icon = 'file';
            }
            return `
                <span class="px-3 py-1 inline-flex text-xs leading-5 font-bold rounded-full items-center space-x-1 ${color}">
                    <i data-lucide="${icon}" class="w-3 h-3"></i>
                    <span>${status}</span>
                </span>
            `;
        }
        
        // FUNGSI PAPER ROW DENGAN TOMBOL EDIT (Diperbarui)
        function createPaperRow(paper) {
            const deadlineDate = paper.deadline ? new Date(paper.deadline).toLocaleDateString('id-ID') : '-';

            // Mengubah format objek paper menjadi string JSON yang aman untuk di passing ke onclick
            const paperJson = JSON.stringify(paper).replace(/'/g, "\\'");
            
            // Ikon Tautan yang Diperbarui
            const linkIcon = (url, iconName, label) => {
                if (!url) return '';
                // Ensure URL starts with http:// or https:// for valid link
                const safeUrl = url.startsWith('http') || url.startsWith('https') ? url : `https://${url}`;
                return `
                    <a href="${safeUrl}" target="_blank" rel="noopener noreferrer" 
                        class="p-1 rounded-full border border-yellow-200 bg-yellow-50 text-yellow-600 hover:bg-yellow-200 hover:border-yellow-400 transition duration-200 shadow-sm" 
                        title="${label}">
                        <i data-lucide="${iconName}" class="w-4 h-4"></i>
                    </a>
                `;
            };

            const links = `
                ${linkIcon(paper.reference_link, 'link', 'Link Referensi')}
                ${linkIcon(paper.overleaf_link, 'file-text', 'Link Overleaf')}
                ${linkIcon(paper.ppt_link, 'monitor', 'Link PPT')}
            `;
            
            return `
                <tr class="hover:bg-yellow-50 transition duration-150">
                    <td class="px-3 py-4 whitespace-normal text-sm font-medium text-gray-900">${paper.title}</td>
                    <td class="px-3 py-4 whitespace-normal text-sm text-gray-500">${paper.authors || '-'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm">${getStatusBadge(paper.status)}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell">${paper.category || '-'}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500 hidden sm:table-cell">${deadlineDate}</td>
                    <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-700 flex space-x-1 items-center">
                        ${links}
                        <!-- TOMBOL EDIT BARU -->
                        <button onclick='openEditModal(${paperJson})'
                            class="p-1 rounded-full border border-blue-200 bg-blue-50 text-blue-600 hover:bg-blue-200 hover:border-blue-400 transition duration-200 shadow-sm" 
                            title="Edit Paper">
                            <i data-lucide="edit-3" class="w-4 h-4"></i>
                        </button>
                    </td>
                </tr>
            `;
        }
        
        async function fetchPapers(searchTerm = '') {
            noDataMessage.classList.add('hidden');
            
            // Tampilkan baris loading di dalam tbody
            papersList.innerHTML = `
                <tr id="loadingRow">
                    <td colspan="6" class="p-4 text-center text-gray-500 flex items-center justify-center">
                        <i data-lucide="loader-circle" class="w-5 h-5 mr-2 animate-spin-fast"></i>
                        Memuat data...
                    </td>
                </tr>
            `;
            // Inisialisasi Lucide untuk memastikan ikon loading terlihat
            lucide.createIcons();

            try {
                let query = supabaseClient.from(TABLE_NAME)
                    .select('*')
                    .order('created_at', { ascending: false });

                if (searchTerm) {
                    // Menggunakan operator 'or' untuk mencari di dua kolom
                    const searchPattern = `%${searchTerm.toLowerCase()}%`;
                    query = query.or(`title.ilike.${searchPattern},authors.ilike.${searchPattern}`);
                }

                const { data, error } = await query;

                if (error) {
                    // Tampilkan pesan error RLS/koneksi
                    let errorMessage = error.message.includes('permission denied')
                        ? `Akses Ditolak (RLS Error). Mohon periksa kebijakan Row-Level Security (RLS) di tabel '${TABLE_NAME}' Supabase.`
                        : `Gagal memuat data: ${error.message}. (Cek Konsol)`;
                    
                    papersList.innerHTML = `<tr><td colspan="6" class="p-4 text-center text-red-500 font-bold">${errorMessage}</td></tr>`;
                    throw error;
                }

                papersList.innerHTML = '';
                if (data && data.length > 0) {
                    data.forEach(paper => {
                        papersList.insertAdjacentHTML('beforeend', createPaperRow(paper));
                    });
                    // Inisialisasi Lucide Icons setelah data dimuat (termasuk tombol Edit)
                    lucide.createIcons(); 
                } else {
                    noDataMessage.classList.remove('hidden');
                }

            } catch (error) {
                // Jangan lakukan apa-apa di sini karena error sudah ditampilkan di blok try
                console.error('Final fetching error (logged):', error.message);
            }
        }

        async function addPaper(event) {
            event.preventDefault();

            const newPaper = {
                title: document.getElementById('title').value.trim(),
                authors: document.getElementById('authors').value.trim() || null,
                status: document.getElementById('status').value,
                category: document.getElementById('category').value.trim() || null,
                deadline: document.getElementById('deadline').value || null,
                reference_link: document.getElementById('reference_link').value.trim() || null,
                overleaf_link: document.getElementById('overleaf_link').value.trim() || null,
                ppt_link: document.getElementById('ppt_link').value.trim() || null,
            };

            if (!newPaper.title || !newPaper.status) {
                showMessage('Judul dan Status wajib diisi!', 'text-red-500');
                return;
            }

            submitButton.disabled = true;
            submitButton.innerHTML = renderSubmitButton('Menyimpan...', 'loader-circle');
            lucide.createIcons();

            try {
                const { error } = await supabaseClient.from(TABLE_NAME).insert([newPaper]);

                if (error) throw error;

                paperForm.reset();
                showMessage('Paper berhasil ditambahkan!', 'text-green-500');
                // Muat ulang daftar dengan filter pencarian yang mungkin aktif
                fetchPapers(searchInput.value);

            } catch (error) {
                console.error('Error adding paper:', error.message);
                let errorMessage = error.message.includes('permission denied')
                    ? `Gagal menambahkan paper: Akses Ditolak (RLS Error). Mohon cek kebijakan INSERT di Supabase.`
                    : `Gagal menambahkan paper: ${error.message}`;
                showMessage(errorMessage, 'text-red-500');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = renderSubmitButton('Tambah Paper', 'file-plus');
                lucide.createIcons();
            }
        }
        
        // --- LOGIKA EDIT MODAL ---

        // Mengisi modal dengan data paper yang dipilih
        function openEditModal(paper) {
            document.getElementById('edit-id').value = paper.id;
            document.getElementById('edit-title-display').textContent = paper.title; // Judul hanya display
            
            // Kolom yang dapat diubah
            document.getElementById('edit-authors').value = paper.authors || '';
            document.getElementById('edit-status').value = paper.status;
            document.getElementById('edit-category').value = paper.category || '';
            
            // Format deadline untuk input type="date" (YYYY-MM-DD)
            document.getElementById('edit-deadline').value = paper.deadline ? paper.deadline.split('T')[0] : '';

            // Link
            document.getElementById('edit-reference_link').value = paper.reference_link || '';
            document.getElementById('edit-overleaf_link').value = paper.overleaf_link || '';
            document.getElementById('edit-ppt_link').value = paper.ppt_link || '';

            editFormMessage.classList.add('hidden');
            editModal.classList.remove('hidden');
            lucide.createIcons(); // Re-render icons in modal
        }

        function closeEditModal() {
            editModal.classList.add('hidden');
        }

        // Fungsi untuk menyimpan hasil edit
        editPaperForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const paperId = document.getElementById('edit-id').value;
            const updatedPaper = {
                authors: document.getElementById('edit-authors').value.trim() || null,
                status: document.getElementById('edit-status').value,
                category: document.getElementById('edit-category').value.trim() || null,
                deadline: document.getElementById('edit-deadline').value || null,
                reference_link: document.getElementById('edit-reference_link').value.trim() || null,
                overleaf_link: document.getElementById('edit-overleaf_link').value.trim() || null,
                ppt_link: document.getElementById('edit-ppt_link').value.trim() || null,
            };

            // Perubahan UI saat menyimpan
            saveEditButton.disabled = true;
            saveEditButton.innerHTML = renderSaveButton('Menyimpan...', 'loader-circle');
            lucide.createIcons();

            try {
                // Supabase UPDATE operation
                const { error } = await supabaseClient
                    .from(TABLE_NAME)
                    .update(updatedPaper)
                    .eq('id', paperId);

                if (error) throw error;

                showEditMessage('Perubahan berhasil disimpan!', 'text-green-500');
                
                // Refresh data di latar belakang
                fetchPapers(searchInput.value); 
                
                // Tutup modal setelah jeda singkat
                setTimeout(closeEditModal, 1000);

            } catch (error) {
                console.error('Error updating paper:', error.message);
                let errorMessage = error.message.includes('permission denied')
                    ? `Gagal menyimpan: Akses Ditolak (RLS Error). Cek kebijakan UPDATE di Supabase.`
                    : `Gagal menyimpan: ${error.message}`;
                showEditMessage(errorMessage, 'text-red-500');
            } finally {
                saveEditButton.disabled = false;
                saveEditButton.innerHTML = renderSaveButton('Simpan Perubahan', 'check');
                lucide.createIcons();
            }
        });

        function showMessage(message, colorClass) {
            formMessage.textContent = message;
            formMessage.className = `col-span-3 text-sm text-center font-semibold ${colorClass}`;
            formMessage.classList.remove('hidden');
            setTimeout(() => {
                formMessage.classList.add('hidden');
            }, 4000);
        }

        function showEditMessage(message, colorClass) {
            editFormMessage.textContent = message;
            editFormMessage.className = `col-span-3 text-sm text-center font-semibold ${colorClass}`;
            editFormMessage.classList.remove('hidden');
            setTimeout(() => {
                editFormMessage.classList.add('hidden');
            }, 3000);
        }

        // --- EVENT LISTENERS ---

        paperForm.addEventListener('submit', addPaper);

        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                fetchPapers(searchInput.value);
            }, 300); // Debounce 300ms
        });

        // --- INISIALISASI ---

        document.addEventListener('DOMContentLoaded', () => {
            // Set status awal tombol submit
            submitButton.innerHTML = renderSubmitButton('Tambah Paper', 'file-plus');
            
            checkSession();
            // Inisialisasi awal untuk semua ikon statis
            lucide.createIcons(); 
        });

    </script>
</body>
</html>
